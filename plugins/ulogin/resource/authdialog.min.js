(function(b,e,f){litepubl.Authdialog=Class.extend({registered:!1,logged:!1,args:!1,email:!1,ulogin:!1,dialog:!1,statusline:!1,tml:'<p>%%lang.description%%</p>%%ulogin%%<hr>%%email%%<p id="authdialog-status">&nbsp;</p>',tml_status:'<span class="text-%%status%%">%%icon%% %%text%%</span>',init:function(){this.registered=litepubl.getuser().pass?1:0;this.email=new litepubl.Emailauth;this.ulogin=new litepubl.Ulogin;if(!this.registered){var a=this;b(e).on("click.authdialog",'a[href^="'+ltoptions.url+'/admin/"], a[href^="/admin/"]',
function(){var c=b(this),d=c.attr("href");litepubl.is_admin_url(d)&&(c.closest("#before-commentform").length?a.auth_comments():a.open({url:d}));return!1})}},auth_comments:function(){this.check({rpc:{type:"get",method:"comments_get_logged",params:{idpost:ltoptions.idpost},callback:function(a){b("#before-commentform").html(a)},error:function(a,c){b.errobox(a)}}})},open:function(a){if(this.dialog)return!1;this.dialog=!0;this.args=b.extend({url:"",rpc:!1,callback:!1},a);a=lang.authdialog;b.litedialog({title:a.title,
width:300,html:b.parsetml(this.tml,{lang:a,ulogin:this.ulogin.html(this.args),email:this.email.html()}),buttons:this.email.buttons(),open:function(a){self.statusline=b("#authdialog-status",a);self.email.onopen(a);self.ulogin.onopen(a);litepubl.stat("authdialog_open")},close:function(){self.dialog=!1;self.statusline=!1;self.email.dialog=!1;litepubl.stat("authdialog_close")}})},setstatus:function(a,c){"error"==a&&(a="danger");this.statusline.html(b.parsetml(this.tml_status,{status:a,icon:b.bsdialog.geticon(a),
text:c}))},setuser:function(a){b(e).off("click.authdialog");litepubl.user=a;set_cookie("litepubl_user_id",a.id);set_cookie("litepubl_user",a.pass);set_cookie("litepubl_regservice",a.regservice);this.logged=this.registered=!0;a=this.args;!a.url||a.rpc||a.callback?this.dialog?b.closedialog(a.callback):b.isFunction(a.callback)&&a.callback():location.href=a.url},check:function(a){var c=b.extend({rpc:!1,callback:!1},a);if(!this.registered)return this.open(c);if(this.logged){if(c.rpc)return b.jsonrpc(c.rpc),
litepubl.stat("authdialog_checklogged"),!1;b.isFunction(c.callback)&&c.callback("logged");return!0}var d=this;b.jsonrpc({method:"check_logged",params:{},slave:c.rpc,callback:function(a){d.logged=!0;b.isFunction(c.callback)&&c.callback()},error:function(a,b){d.open(c)}});litepubl.stat("authdialog_checklogged");return!1}});b(e).ready(function(){litepubl.authdialog=new litepubl.Authdialog})})(jQuery,document,window);
