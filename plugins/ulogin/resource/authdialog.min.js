/*
  2010 - 2016 Vladimir Yushko http://litepublisher.com/ http://litepublisher.ru/
 @license   https://github.com/litepubl/cms/blob/master/LICENSE.txt MIT
 @link https://github.com/litepubl\cms
 @version 6.15
*/
(function(c,e,f){litepubl.Authdialog=Class.extend({registered:!1,logged:!1,args:!1,email:!1,ulogin:!1,dialog:!1,statusline:!1,tml:'<p class="help-block text-center"><a href="#" id="authdialog-help" class="dashed"><span class="fa fa-question"></span> %%lang.helptitle%%</a></p>%%ulogin%%%%email%%<p id="authdialog-status">&nbsp;</p>',tml_status:'<span class="text-%%status%%">%%icon%% %%text%%</span>',init:function(){this.registered=litepubl.getuser().pass?1:0;this.email=new litepubl.Emailauth;this.ulogin=
new litepubl.Ulogin;if(!this.registered){var a=this;c(e).on("click.authdialog",'a[href^="'+ltoptions.url+'/admin/"], a[href^="/admin/"]',function(){var b=c(this),d=b.attr("href");if(b.closest("#before-commentform").length)a.auth_comments();else if(litepubl.is_admin_url(d))a.open({url:d});else return;return!1})}},auth_comments:function(){this.check({rpc:{type:"get",method:"comments_get_logged",params:{idpost:ltoptions.idpost},callback:function(a){c("#before-commentform").html(a)},error:function(a,
b){c.errorbox(a)}}})},open:function(a){if(this.dialog)return!1;this.dialog=!0;this.args=c.extend({url:"",rpc:!1,callback:!1},a);a=lang.authdialog;var b=this;c.litedialog({title:a.title,width:300,css:this.ulogin.css+this.email.css,html:c.parsetml(this.tml,{lang:a,ulogin:this.ulogin.html(this.args),email:this.email.html()}),buttons:this.email.buttons(),open:function(a){c("#authdialog-help",a).popover({container:"body",delay:120,html:!0,placement:"bottom",trigger:"hover focus click",title:function(){return c(this).text()},
content:function(){return"<ul><li>"+lang.authdialog.help.replace(/\n/gm,"</li><li>")+"</li></ul>"}});b.statusline=c("#authdialog-status",a);b.email.onopen(a);b.ulogin.onopen(a);litepubl.stat("authdialog_open")},close:function(){b.email.onclose();b.ulogin.onclose();b.statusline=!1;b.dialog=!1;litepubl.stat("authdialog_close")}})},setstatus:function(a,b){"error"==a&&(a="danger");this.statusline.html(c.parsetml(this.tml_status,{status:a,icon:c.bsdialog.geticon(a),text:b}))},setuser:function(a){c(e).off("click.authdialog");
litepubl.user=a;set_cookie("litepubl_user_id",a.id);set_cookie("litepubl_user",a.pass);set_cookie("litepubl_regservice",a.regservice);this.logged=this.registered=!0;a=this.args;!a.url||a.rpc||a.callback?this.dialog?c.closedialog(a.callback):c.isFunction(a.callback)&&a.callback():location.href=a.url},check:function(a){var b=c.extend({rpc:!1,callback:!1},a);if(!this.registered)return this.open(b);if(this.logged){if(b.rpc)return c.jsonrpc(b.rpc),litepubl.stat("authdialog_checklogged"),!1;c.isFunction(b.callback)&&
b.callback("logged");return!0}var d=this;c.jsonrpc({method:"check_logged",params:{},slave:b.rpc,callback:function(a){d.logged=!0;c.isFunction(b.callback)&&b.callback()},error:function(a,c){d.open(b)}});litepubl.stat("authdialog_checklogged");return!1}});c(function(){litepubl.authdialog=new litepubl.Authdialog})})(jQuery,document,window);
