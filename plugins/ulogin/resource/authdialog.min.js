(function(b,e,f){litepubl.Authdialog=Class.extend({registered:!1,logged:!1,args:!1,email:!1,ulogin:!1,beforeForm:"#before-commentform",dialog:!1,statusline:!1,tml:'<p class="help-block text-center"><a href="#" id="authdialog-help" class="dashed"><span class="fa fa-question"></span> %%lang.helptitle%%</a></p>%%ulogin%%%%email%%<p id="authdialog-status">&nbsp;</p>',tml_status:'<span class="text-%%status%%">%%icon%% %%text%%</span>',init:function(){this.registered=litepubl.getuser().pass?1:0;this.email=
new litepubl.Emailauth;this.ulogin=new litepubl.Ulogin;if(!this.registered){var a=this;b(e).on("click.authdialog",'a[href^="'+ltoptions.url+'/admin/"], a[href^="/admin/"]',function(){var c=b(this),d=c.attr("href");if(c.closest("#before-commentform").length)a.auth_comments();else if(litepubl.is_admin_url(d))a.open({url:d});else return;return!1})}},auth_comments:function(){this.check({rpc:{type:"get",method:"comments_get_logged",params:{idpost:ltoptions.idpost},callback:b.proxy(this.commentsLogged,
this),error:function(a,c){b.errorbox(a)}}})},commentsLogged:function(a){b(this.beforeForm).html(a);ltoptions.theme.comments.form.off("submit.confirmcomment")},open:function(a){if(this.dialog)return!1;this.dialog=!0;this.args=b.extend({url:"",rpc:!1,callback:!1},a);a=lang.authdialog;var c=this;b.litedialog({title:a.title,width:300,css:this.ulogin.css+this.email.css,html:b.parsetml(this.tml,{lang:a,ulogin:this.ulogin.html(this.args),email:this.email.html()}),buttons:this.email.buttons(),open:function(a){b("#authdialog-help",
a).popover({container:"body",delay:120,html:!0,placement:"bottom",trigger:"hover focus click",title:function(){return b(this).text()},content:function(){return"<ul><li>"+lang.authdialog.help.replace(/\n/gm,"</li><li>")+"</li></ul>"}});c.statusline=b("#authdialog-status",a);c.email.onopen(a);c.ulogin.onopen(a);litepubl.stat("authdialog_open")},close:function(){c.email.onclose();c.ulogin.onclose();c.statusline=!1;c.dialog=!1;litepubl.stat("authdialog_close")}})},setstatus:function(a,c){"error"==a&&
(a="danger");this.statusline.html(b.parsetml(this.tml_status,{status:a,icon:b.bootstrapDialog.geticon(a),text:c}))},setuser:function(a){b(e).off("click.authdialog");litepubl.user=a;set_cookie("litepubl_user_id",a.id);set_cookie("litepubl_user",a.pass);set_cookie("litepubl_regservice",a.regservice);this.logged=this.registered=!0;a=this.args;!a.url||a.rpc||a.callback?this.dialog?b.closedialog(a.callback):b.isFunction(a.callback)&&a.callback():location.href=a.url},check:function(a){var c=b.extend({rpc:!1,
callback:!1},a);if(!this.registered)return this.open(c);if(this.logged){if(c.rpc)return b.jsonrpc(c.rpc),litepubl.stat("authdialog_checklogged"),!1;b.isFunction(c.callback)&&c.callback("logged");return!0}var d=this;b.jsonrpc({method:"check_logged",params:{},slave:c.rpc,callback:function(a){d.logged=!0;b.isFunction(c.callback)&&c.callback()},error:function(a,b){d.open(c)}});litepubl.stat("authdialog_checklogged");return!1}});b(function(){litepubl.authdialog=new litepubl.Authdialog})})(jQuery,document,
window);
