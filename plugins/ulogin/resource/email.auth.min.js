(function(b,k,d){litepubl.Emailauth=Class.extend({dialog:!1,tml_edit:'<div class="input-group"><span class="input-group-addon"><span class="fa fa-%%icon%%"></span></span><label class="sr-only" for="text-%%name%%" >%%title%%</label><input type="text" class="form-control" name="%%name%%" id="text-%%name%%" value="%%value%%" placeholder="%%title%%" /></div>',css:".modal-body .input-group-addon {width:3em}",getradio:function(a){return b.simpletml(litepubl.tml.radio,{name:"authtype",value:a,title:lang.authdialog[a]})},
get_storage_email:function(){if("localStorage"in d)try{var a=d.localStorage.getItem("authdialog_email");return a?a:""}catch(b){}return""},set_storage_email:function(a){if("localStorage"in d)try{d.localStorage.setItem("authdialog_email",a)}catch(b){}},html:function(){var a=lang.authdialog;return this.getradio("reg")+this.getradio("login")+this.getradio("lostpass")+b.parsetml(this.tml_edit,{name:"email-emailauth",icon:"envelope",value:this.get_storage_email(),title:"E-Mail"})+b.parsetml(this.tml_edit,
{name:"name-emailauth",icon:"user",value:"",title:a.name})+b.parsetml(this.tml_edit,{name:"password-emailauth",icon:"lock",value:"",title:a.password}).replace(/text/gim,"password")},onopen:function(a){this.dialog=a;var c=b("#text-email-emailauth",a).val()?"login":"reg";b("input[name=authtype]",a).on("click.emailauth",function(){var h=b(this).val(),c=b("#text-name-emailauth",a).parent(),e=b("#password-password-emailauth",a).parent(),d=b("button[data-index=0]",a),f=b("button[data-index=1]",a),g=b("button[data-index=2]",
a);switch(h){case "reg":c.show();d.show();e.hide();f.hide();g.hide();break;case "login":e.show();f.show();c.hide();d.hide();g.hide();break;case "lostpass":c.hide(),e.hide(),d.hide(),f.hide(),g.show()}}).filter("[value="+c+"]").click();"tooltip"in b.fn&&b("input[placeholder]",a).addClass("tooltip-ready").tooltip({container:"body",placement:"top",trigger:"focus",title:function(){return b(this).attr("placeholder")}})},onclose:function(){this.dialog=!1},buttons:function(){var a=this,c=lang.authdialog;
return[{title:c.regbutton,icon:'<span class="fa fa-user-plus"></span> ',click:function(){var c=a.getemail();if(!c)return!1;var d=b("#text-name-emailauth",a.dialog),e=b.trim(d.val());e?a.reg(c,e):d.focus();litepubl.stat("emailauth_reg");return!1}},{title:c.loginbutton,icon:'<span class="fa fa-sign-in"></span> ',click:function(){var c=a.getemail();if(!c)return!1;var d=b("#password-password-emailauth",a.dialog),e=b.trim(d.val());e?a.login(c,e):d.focus();litepubl.stat("emailauth_login");return!1}},{title:c.lostpassbutton,
icon:'<span class="fa fa-user-secret"></span> ',click:function(){var b=a.getemail();b&&a.lostpass(b);litepubl.stat("emailauth_lostpass");return!1}},{title:lang.dialog.close,icon:'<span class="fa fa-close"></span> ',click:b.closedialog}]},getemail:function(){var a=b("#text-email-emailauth",this.dialog),c=b.trim(a.val());if(c&&/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/.test(c))return this.set_storage_email(c),c;a.focus();litepubl.authdialog.setstatus("error",lang.authdialog.errmail);
litepubl.stat("emailauth_errmail");return!1},disable:function(a){b(":input",this.dialog).prop("disabled",a)},login:function(a,c){var d=litepubl.authdialog;return this.ajax({method:"email_login",params:{email:a,password:c},slave:d.args.rpc,callback:b.proxy(d.setuser,d)})},ajax:function(a){this.disable(!0);var c=this;a.error=function(a,b){c.disable(!1);litepubl.authdialog.setstatus("error",a)};litepubl.authdialog.setstatus("info",lang.authdialog.request);return b.jsonrpc(a)},setstatus:function(a){this.disable(!1);
b("input[value=login]",this.dialog).click();b("#password-password-emailauth",this.dialog).focus();litepubl.authdialog.setstatus("success",lang.authdialog[a])},reg:function(a,b){var d=this;return this.ajax({method:"email_reg",params:{email:a,name:b},callback:function(a){d.setstatus("registered")}})},lostpass:function(a,b){var d=this;return this.ajax({method:"email_lostpass",params:{email:a,name:b},callback:function(a){d.setstatus("restored")}})}})})(jQuery,document,window);
