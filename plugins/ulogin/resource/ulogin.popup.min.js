(function(b,g,f){b(g).ready(function(){litepubl.ulogin=new litepubl.Ulogin});litepubl.Ulogin=Class.extend({registered:!1,logged:!1,script:!1,dialog:!1,html:'<div><p>%%lang.subtitle%%</p><div id="ulogin-dialog"><div id="ulogin-holder" data-ulogin="display=small;fields=first_name,last_name;optional=email,phone,nickname;providers=vkontakte,odnoklassniki,mailru,yandex,facebook,google,twitter;hidden=other;redirect_uri=%%redirurl%%;%%callback%%"></div></div><div><a href="%%url%%" id="email-login">%%lang.emaillogin%%</a></div></div>',
init:function(){this.registered=litepubl.getuser().pass?1:0;if(!this.registered){var a=this;b('a[href^="'+ltoptions.url+'/admin/"], a[href^="/admin/"]').click(function(){var c=b(this).attr("href");litepubl.is_admin_url(c)&&a.open(c);return!1});b("#ulogin-comment-button").click(function(){a.onlogged({type:"get",method:"comments_get_logged",params:{idpost:ltoptions.idpost},callback:function(a){b("#before-commentform").html(a)},error:function(a,d){b.messagebox(lang.dialog.error,a)}});return!1})}},open:function(a){if(this.dialog)return!1;
a=b.extend({url:ltoptions.url+"/admin/login/?backurl="+encodeURIComponent(location.href),callback:!1,email:function(){f.location=a.url}},a);var c=this;c.ready(function(){c.dialog=!0;var d=lang.ulogin,e=c.html.replace(/%%lang.emaillogin%%/gim,d.emaillogin).replace(/%%lang.subtitle%%/gim,d.subtitle).replace(/%%url%%/gim,a.url);b.isFunction(a.callback)?(e=e.replace(/%%callback%%/gim,"callback=ulogincallback").replace(/%%redirurl%%/gim,""),f.ulogincallback=function(c){b.closedialog();try{a.callback(c),
litepubl.stat("ulogin_token")}catch(d){erralert(d)}}):e=e.replace(/%%callback%%/gim,"").replace(/%%redirurl%%/gim,encodeURIComponent(ltoptions.url+"/admin/ulogin.php?backurl="+encodeURIComponent(a.url)));b.litedialog({title:d.title,html:e,width:300,close:function(){c.dialog=!1;litepubl.stat("ulogin_close")},open:function(){uLogin.customInit("ulogin-holder");b("#email-login").click(function(){b.closedialog(function(){"emailauth"in litepubl||(litepubl.emailauth=new litepubl.Emailauth);litepubl.emailauth.open(a.email)});
return!1});litepubl.stat("ulogin_open")},buttons:[{title:lang.dialog.close,click:b.closedialog}]})})},ready:function(a){return this.script?this.script.done(a):this.script=b.load_script("//ulogin.ru/js/ulogin.js",a)},auth:function(a,c,d){var e=this;return b.jsonrpc({method:"ulogin_auth",params:{token:a},slave:c,callback:function(a){litepubl.user=a;set_cookie("litepubl_user_id",a.id);set_cookie("litepubl_user",a.pass);set_cookie("litepubl_regservice",a.regservice);e.registered=!0;e.logged=!0;b.isFunction(d)&&
d()}})},login:function(a,c,b){var e=this;e.open({url:a,callback:function(a){e.auth(a,c,b)},email:b})},logon:function(a,c){var d=this;d.open({url:"",callback:function(b){d.auth(b,a,c)},email:function(){a?b.jsonrpc(a):b.isFunction(c)&&c()}})},onlogged:function(a,c){if(!this.registered)return this.logon(a,c);if(this.logged){if(a)return b.jsonrpc(a),litepubl.stat("ulogin_checklogged"),!1;b.isFunction(c)&&c("logged");return!0}var d=this;b.jsonrpc({method:"check_logged",params:{},slave:a,callback:function(a){d.logged=
!0;b.isFunction(c)&&c()},error:function(b,f){d.logon(a,c)}});litepubl.stat("ulogin_checklogged");return!1}})})(jQuery,document,window);
