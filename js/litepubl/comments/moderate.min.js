(function(c,m,n){litepubl.Moderate=Class.extend({enabled:!0,init:function(){this.onbuttons=c.Callbacks();var d=this,a=ltoptions.theme.comments,e=c(a.loadhold).click(function(){c(this).remove();d.loadhold();return!1});a.holdtemplate=e.length?e.get(0).nextSibling:!1;this.create_buttons(a.comments)},setenabled:function(d){d!=this.enabled&&((this.enabled=d)?c(this.options.buttons).show():c(this.options.buttons).hide())},error:function(d){this.setenabled(!0);c.messagebox(lang.dialog.error,d)},setstatus:function(d,
a){var e=this,b=ltoptions.theme.comments,f=b.comment+d;switch(a){case "delete":case "del":this.setenabled(!1);c.confirmbox(lang.dialog.confirm,lang.comments.confirmdelete,lang.comments.yesdelete,lang.comments.nodelete,function(a){if(0!=a)return e.setenabled(!0);c.jsonrpc({type:"get",method:"comment_delete",params:{id:d},callback:function(a){if(0==a)return e.error(lang.comments.notdeleted);c(f).remove();e.setenabled(!0)},error:function(a,b){e.error(lang.comments.notdeleted)}})});break;case "hold":case "approved":case "approve":this.setenabled(!1);
c.jsonrpc({type:"get",method:"comment_setstatus",params:{id:d,status:"hold"==a?"hold":"approved"},callback:function(f){try{if(0==f)return e.error(lang.comments.notmoderated);if(!b.holdcomments&&b.holdtemplate){var g=b.holdtemplate;b.holdcontainer=c(g.nodeValue).insertAfter(b.comments);b.holdcomments=b.holdcontainer.parent().find(b.hold);e.create_buttons(b.holdcomments);g.parentNode.removeChild(g);comtheme.holdtemplate=null}c("hold"==a?b.holdcomments:b.comments).append(c(b.comment+d));e.setenabled(!0)}catch(h){erralert(h)}},
error:function(a,b){e.error(lang.comments.notmoderated)}});break;case "edit":this.setenabled(!1);c.jsonrpc({type:"get",method:"comment_getraw",params:{id:d},callback:function(a){try{e.edit(d,a.rawcontent)}catch(b){erralert(b)}},error:function(a,b){e.error(lang.comments.errorrecieved)}});break;default:alert("Unknown status "+a)}},edit:function(d,a){var e=ltoptions.theme.comments.editor;e.data("idcomment",d).data("savedtext",e.val()).val(a).focus();c.onEscape(c.proxy(this.restore_submit,this));var b=
this,f=ltoptions.theme.comments.form;f.off("submit.confirmcomment").on("submit.moderate",function(){try{var a=c.trim(e.val());if(""==a)return b.enabled=!0,b.error(lang.comment.emptycontent),b.enabled=!1;c(":input",f).prop("disabled",!0);c.jsonrpc({method:"comment_edit",params:{id:e.data("idcomment"),content:a},callback:function(a){try{c(":input",f).prop("disabled",!1);var d=ltoptions.theme.comments.content+a.id;c(d).html(a.content);b.restore_submit();location.hash=d.substring(1)}catch(e){erralert(e)}},
error:function(a,d){c(":input",f).prop("disabled",!1);b.error(lang.comments.notedited);b.restore_submit()}})}catch(d){erralert(d)}return!1})},restore_submit:function(){var d=ltoptions.theme.comments.editor;d.val(d.data("savedtext"));this.setenabled(!0);ltoptions.theme.comments.form.off("submit.moderate").on("submit.confirmcomment",function(){if("confirmcomment"in litepubl)return litepubl.confirmcomment.submit()})},loadhold:function(){var d=this;c.jsonrpc({type:"get",method:"comments_get_hold",params:{idpost:ltoptions.idpost},
callback:c.proxy(this.inserthold,this),error:function(a,c){d.error(lang.comments.errorrecieved)}})},inserthold:function(d){try{var a=ltoptions.theme.comments,e=a.holdtemplate;e&&(e.parentNode.removeChild(e),a.holdtemplate=null);var b=a.holdcontainer;b&&b.length?(contheme.holdcontainer=c(d.items).insertBefore(b),b.remove(),b=contheme.holdcontainer):b=contheme.holdcontainer=c(d.items).insertAfter(a.comments);a.holdcomments=b.parent().find(a.hold);this.create_buttons(a.holdcomments)}catch(f){erralert(f)}},
create_buttons:function(d){var a=ltoptions.theme.comments,e=this;d.on("click.moder",a.buttons,function(){if(!e.enabled)return!1;var a=c(this);e.setstatus(a.parent().attr("data-idcomment"),a.attr("data-moder"));return!1});var a=ltoptions.theme.comments,b=d.find(a.buttons+(a.ismoder?"":'[data-idauthor="'+litepubl.getuser().id+'"]'));b.length||rturn;if(a.ismoder)var f=["approve","hold","del","edit"];else{if(!a.canedit&&!a.candelete)return;a.canedit&&f.push("edit");a.candelete&&f.push("del")}var k="",
g=a.button;0>g.indexOf("data-moder")&&(g=g.replace("class=",'data-moder="%%name%%" class='));for(var h=0;h<f.length;h++)var l=f[h],k=k+c.simpletml(g,{title:lang.comments[l],name:l});b.append(k);b.first().is(":hidden")&&(a=c.simpletml(a.button,{title:"E",name:"show"}),a=a.replace('class="','class="showbutton '),container.before(a),d.on("click.showbutton mouseenter.showbutton focus.showbutton",".showbutton",function(){c(this).next().show();c(this).remove();return!1}));this.onbuttons.fire(b)}});c.ready2(function(){litepubl.getuser().id&&
(litepubl.moderate=new litepubl.Moderate)})})(jQuery,document,window);
