(function(b,l,m){litepubl.Moderate=Class.extend({enabled:!0,init:function(){this.onbuttons=b.Callbacks();var c=this;b(".loadhold").click(function(){b(this).parent().remove();c.loadhold();return!1});var a=ltoptions.theme.comments;this.create_buttons(b().add(a.comments).add(a.holdcomments))},setenabled:function(c){c!=this.enabled&&((this.enabled=c)?b(this.options.buttons).show():b(this.options.buttons).hide())},error:function(c){this.setenabled(!0);b.messagebox(lang.dialog.error,c)},setstatus:function(c,
a){var d=this,e=ltoptions.theme.comments,f=e.comment+c;switch(a){case "delete":case "del":this.setenabled(!1);b.confirmbox(lang.dialog.confirm,lang.comments.confirmdelete,lang.comments.yesdelete,lang.comments.nodelete,function(a){if(0!=a)return d.setenabled(!0);b.jsonrpc({type:"get",method:"comment_delete",params:{id:c},callback:function(a){if(0==a)return d.error(lang.comments.notdeleted);b(f).remove();d.setenabled(!0)},error:function(a,b){d.error(lang.comments.notdeleted)}})});break;case "hold":case "approved":case "approve":this.setenabled(!1);
b.jsonrpc({type:"get",method:"comment_setstatus",params:{id:c,status:"hold"==a?"hold":"approved"},callback:function(g){try{if(0==g)return d.error(lang.comments.notmoderated);b("hold"==a?e.hold:e.comments).append(b(e.comment+c));d.setenabled(!0)}catch(h){erralert(h)}},error:function(a,b){d.error(lang.comments.notmoderated)}});break;case "edit":this.setenabled(!1);b.jsonrpc({type:"get",method:"comment_getraw",params:{id:c},callback:function(a){try{d.edit(c,a.rawcontent)}catch(b){erralert(b)}},error:function(a,
b){d.error(lang.comments.errorrecieved)}});break;default:alert("Unknown status "+a)}},edit:function(c,a){var d=ltoptions.theme.comments.editor;d.data("idcomment",c).data("savedtext",d.val()).val(a).focus();b.onEscape(b.proxy(this.restore_submit,this));var e=this,f=ltoptions.theme.comments.form;f.off("submit.confirmcomment").on("submit.moderate",function(){try{var a=b.trim(d.val());if(""==a)return e.enabled=!0,e.error(lang.comment.emptycontent),e.enabled=!1;b(":input",f).prop("disabled",!0);b.jsonrpc({method:"comment_edit",
params:{id:d.data("idcomment"),content:a},callback:function(a){try{b(":input",f).prop("disabled",!1);var c=ltoptions.theme.comments.content+a.id;b(c).html(a.content);e.restore_submit();location.hash=c.substring(1)}catch(d){erralert(d)}},error:function(a,c){b(":input",f).prop("disabled",!1);e.error(lang.comments.notedited);e.restore_submit()}})}catch(c){erralert(c)}return!1})},restore_submit:function(){var b=ltoptions.theme.comments.editor;b.val(b.data("savedtext"));this.setenabled(!0);ltoptions.theme.comments.form.off("submit.moderate").on("submit.confirmcomment",
function(){if("confirmcomment"in litepubl)return litepubl.confirmcomment.submit()})},loadhold:function(){b.jsonrpc({type:"get",method:"comments_get_hold",params:{idpost:ltoptions.idpost},callback:function(c){try{var a=ltoptions.theme.comments,d=a.holdcomments;if(a.ismoder&&d.length){for(;a.comments.next()[0]!=d[0];)a.comments.next().remove();d.remove()}a.comments.after(c.items);a.holdcomments=b(a.hold);self.create_buttons(a.holdcomments)}catch(e){erralert(e)}},error:function(b,a){self.error(lang.comments.errorrecieved)}})},
create_buttons:function(c){var a=ltoptions.theme.comments,d=this;c.on("click.moder",a.buttons,function(){if(!d.enabled)return!1;var a=b(this);d.setstatus(a.parent().attr("data-idcomment"),a.attr("data-moder"));return!1});a=ltoptions.theme.comments;if(a.ismoder)var e=["approve","hold","del","edit"];else{if(!a.canedit&&!a.candelete)return;a.canedit&&e.push("edit");a.candelete&&e.push("del")}var f="",g=a.button;0>g.indexOf("data-moder")&&(g=g.replace("class=",'data-moder="%%name%%" class='));for(var h=
0;h<e.length;h++)var k=e[h],f=f+b.simpletml(g,{title:lang.comments[k],name:k});e=c.find(a.buttons+(a.ismoder?"":'[data-idauthor="'+litepubl.getuser().id+'"]')).append(f);e.length&&e.first().is(":hidden")&&(a=b.simpletml(a.button,{title:"E",name:"show"}),a=a.replace('class="','class="showbutton '),container.before(a),c.on("click.showbutton mouseenter.showbutton focus.showbutton",".showbutton",function(){b(this).next().show();b(this).remove();return!1}));this.onbuttons.fire(e)}});b.ready2(function(){litepubl.getuser().id&&
(litepubl.moderate=new litepubl.Moderate)})})(jQuery,document,window);
