(function(c,f,h){f.init_fileman=function(b){return new f.Fileman(b)};f.Fileman=Class.extend({items:!1,curr:!1,indialog:!1,holder:!1,init:function(b){this.items={};this.curr=[];b=c.extend({holder:"#posteditor-filelist",pages:0,items:!1},b);try{this.init_templates();this.holder=c(b.holder);var a=this;c("#posteditor-files-tabs",this.holder).tabs({hide:!0,show:!0,beforeLoad:f.uibefore,beforeActivate:function(b,d){"empty"==c(d.newPanel).data("files")&&a.loadpage(d.newPanel,c(d.newPanel).data("page"))}});
this.holder.closest("form").submit(function(){c("input[name='files']",a.holder).val(a.curr.join(","))});this.init_upload();b.items?this.set_uploaded(b.pages,b.items):this.load_current_files()}catch(d){erralert(d)}},init_templates:function(){this.tml=f.tml.fileman;c.replacetml(f.tml.fileman,{lang:lang.posteditor,iconurl:ltoptions.files+"/js/litepublisher/icons/"})},init_upload:function(){this.uploader=new f.Uploader;this.uploader.onupload.add(c.proxy(this.uploaded,this))},load_current_files:function(){var b=
this;c.jsonrpc({type:"get",method:"files_getpost",params:{idpost:ltoptions.idpost},callback:function(a){try{b.set_uploaded(a.count,a.files)}catch(c){erralert(c)}},error:function(a,b){c.messagebox(lang.dialog.error,a)}})},set_uploaded:function(b,a){this.set_tabs_count(b);for(var c in a){var e=a[c];this.items[e.id]=e;0==parseInt(e.parent)&&this.curr.push(e.id)}this.setpage("#current-files",a);this.setpage("#new-files",{})},set_tabs_count:function(b){if(!(1>b)){for(var a=c("#posteditor-files-tabs",this.holder),
d=c(".ui-tabs-nav",a),e=1;e<=b;e++)c(this.tml.tab.replace("%%index%%",e)).appendTo(a).data("page",e).data("files","empty"),c(this.tml.tabli.replace(/%%index%%/gim,e)).appendTo(d);a.tabs("refresh")}},setpage:function(b,a){var d=c(".file-items",b),e;for(e in a)0==parseInt(a[e].parent)&&d.append(this.get_fileitem(e));var g=this;d.on("click.toolbar",".file-toolbar > a, .file-toolbar > button",function(){var a=c(this),b=a.closest(".file-item"),d=b.data("idfile");a.hasClass("add-toolbutton")?g.add(d):a.hasClass("delete-toolbutton")?
g.del(d,b):a.hasClass("property-toolbutton")&&g.editprops(d,b);return!1});d.on("click.image","a.file-image",function(){f.linkimage(c(this));return!1})},get_fileitem:function(b){var a=this.items[b];a.link=ltoptions.files+"/files/"+a.filename;a.previewlink="";var d=a.media in this.tml?a.media:"file";0!=parseInt(a.preview)&&a.preview in this.items&&(a.previewlink=ltoptions.files+"/files/"+this.items[a.preview].filename);a=c.simpletml(this.tml.item,{id:a.id,content:c.simpletml(this.tml[d],a)});return c(a).data("idfile",
b)},loadpage:function(b,a){var d=this;c(b).data("files","loading");c.jsonrpc({type:"get",method:"files_getpage",params:{page:a-1},callback:function(a){d.joinitems(a.files);d.setpage(b,a.files)},error:function(a,b){c.messagebox(lang.dialog.error,a)}})},joinitems:function(b){for(var a in b)this.items[a]=b[a]},uploaded:function(b){try{var a=b.id;this.curr.push(a);this.items[a]=b.item;0!=parseInt(b.item.preview)&&(this.items[b.preview.id]=b.preview);c("#current-files .file-items").append(this.get_fileitem(a));
c("#new-files .file-items").append(this.get_fileitem(a))}catch(d){erralert(d)}},add:function(b){0>c.inArray(b,this.curr)&&this.curr.push(b)},del:function(b,a){var d=c.inArray(b,this.curr);if(0>d&&(b=parseInt(b),d=c.inArray(b,this.curr),0>d))return;this.curr.splice(d,1);a.parent();a.remove()},editprops:function(b,a){if(this.indialog)return!1;this.indialog=!0;var d=this.items[b],e=this;c.litedialog({title:lang.posteditor.property,html:this.tml.fileprops,open:function(a){c("input[name='fileprop-title']",
a).val(d.title);c("input[name='fileprop-description']",a).val(d.description);c("input[name='fileprop-keywords']",a).val(d.keywords)},buttons:[{title:"Ok",click:function(){var d=c(".pp_inline"),d={title:c.trim(c("input[name='fileprop-title']",d).val()),description:c.trim(c("input[name='fileprop-description']",d).val()),keywords:c.trim(c("input[name='fileprop-keywords']",d).val())};c.closedialog();e.setprops(b,d,a)}},{title:lang.dialog.cancel,click:function(){c.closedialog();e.indialog=!1}}]})},setprops:function(b,
a,d){c.extend(this.items[b],a);a.idfile=b;var e=this;return c.jsonrpc({method:"files_setprops",params:a,callback:function(a){e.items[a.item.id]=a.item;d&&d.replaceWith(e.get_fileitem(b));e.indialog=!1},error:function(a,b){e.indialog=!1;c.messagebox(lang.dialog.error,a)}})}})})(jQuery,litepubl,window);
