(function(d,e,g){e.init_fileman=function(a){return new e.Fileman(a)};e.Fileman=Class.extend({loaded:!1,items:!1,count:0,dialog:!1,browser:!1,holder:!1,init:function(a){this.loaded=[];this.items={};this.tml=e.tml.fileman;d.replacetml(this.tml,{lang:lang.posteditor});a=d.extend({holder:"#posteditor-filelist",count:0,items:!1},a);var b=this,c=this.holder=d(a.holder);c.closest("form").submit(function(){d("input[name='files']",b.holder).val(b.loaded.join(","))});c.on("click.toolbar",".file-toolbar > button, .file-toolbar > a",
function(){var a=d(this),c=a.closest(".file-item"),f=c.attr("data-idfile");a.hasClass("delete-toolbutton")?(c.remove(),b.remove(f)):a.hasClass("property-toolbutton")&&b.editprops(f,c);return!1});c.on("click.image",".file-image",function(){b.openimage(d(this));return!1});c.find("#browsefiles").on("click.browsefiles",function(){b.browsefiles();return!1});try{this.init_uploader(),a.items?(this.count=a.count,this.set_uploaded(a.items)):this.files_getpost()}catch(f){erralert(f)}},files_getpost:function(){var a=
this;d.jsonrpc({type:"get",method:"files_getpost",params:{idpost:ltoptions.idpost},callback:function(b){try{a.count=b.count,a.set_uploaded(b.files)}catch(c){erralert(c)}},error:function(a,c){d.errorbox(a)}})},set_uploaded:function(a){for(var b in a){var c=a[b];this.items[c.id]=c;parseInt(c.parent)||this.loaded.push(c.id)}b=d("#oldfiles",this.holder);this.loaded.length?(this.append(b,a),b.removeClass("hidden")):b.addClass("hidden")},append:function(a,b){var c="",d;for(d in b)parseInt(b[d].parent)||
(c+=this.get_fileitem(d));a.append(c)},openimage:function(a){e.linkimage(a)},get_fileitem:function(a){a=this.items[a];a.link=ltoptions.files+"/files/"+a.filename;a.previewlink="";var b=a.media in this.tml?a.media:"file";parseInt(a.preview)&&a.preview in this.items&&(a.previewlink=ltoptions.files+"/files/"+this.items[a.preview].filename);return d.parsetml(this.tml.item,{id:a.id,content:d.parsetml(this.tml[b],a)})},init_uploader:function(){this.uploader=new e.Uploader;this.uploader.onupload.add(d.proxy(this.uploaded,
this))},uploaded:function(a){try{var b=a.id;this.loaded.push(b);this.items[b]=a.item;parseInt(a.item.preview)&&(this.items[a.preview.id]=a.preview);var c=d("#newfiles",this.holder);c.find("#nonewfiles").hide();c.append(this.get_fileitem(b))}catch(f){erralert(f)}},add:function(a){0>d.inArray(a,this.loaded)&&(this.loaded.push(a),d("#oldfiles",this.holder).removeClass("hidden").append(this.get_fileitem(a)))},remove:function(a){var b=d.inArray(a,this.loaded);if(0>b&&(a=parseInt(a),b=d.inArray(a,this.loaded),
0>b))return;this.loaded.splice(b,1)},editprops:function(a,b){if(this.dialog)return!1;var c=this;this.dialog=new e.Filemanprops(this.items[a],function(){c.dialog=!1},function(d){c.items[d.item.id]=d.item;b.replaceWith(c.get_fileitem(a))})},browsefiles:function(){this.browser?this.browser.open():this.browser=new e.Filemanbrowser(this)}})})(jQuery,litepubl,window);
