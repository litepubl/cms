(function(d,e,f){e.init_fileman=function(a){return new e.Fileman(a)};e.Fileman=Class.extend({loaded:!1,items:!1,count:0,dialog:!1,browser:!1,holder:!1,newfiles:!1,init:function(a){this.loaded=[];this.items={};this.tml=e.tml.fileman;d.replacetml(this.tml,{lang:lang.posteditor});a=d.extend({holder:"#posteditor-filelist",count:0,items:!1},a);var b=this,c=this.holder=d(a.holder);c.closest("form").submit(function(){d("input[name='files']:first",b.holder).val(b.loaded.join(","))});this.newfiles=c.find("#newfiles").on("click.toolbar",
".file-toolbar > button, .file-toolbar > a",function(){var a=d(this),c=a.closest(".file-item"),e=c.attr("data-idfile");a.hasClass("delete-toolbutton")?(c.remove(),b.remove(e)):a.hasClass("property-toolbutton")&&b.editprops(e,c);return!1}).on("click.image",".file-image",function(){b.openimage(d(this).closest("[data-idfile]").attr("data-idfile"));return!1});c.find("#browsefiles").on("click.browsefiles",function(){b.browsefiles();return!1});try{this.init_uploader(),a.items?(this.count=a.count,this.set_uploaded(a.items)):
this.files_getpost()}catch(g){erralert(g)}},files_getpost:function(){var a=this;d.jsonrpc({type:"get",method:"files_getpost",params:{idpost:ltoptions.idpost},callback:function(b){try{a.count=b.count,a.set_uploaded(b.files)}catch(c){erralert(c)}},error:function(a,c){d.errorbox(a)}})},set_uploaded:function(a){for(var b in a){var c=a[b];this.items[c.id]=c;parseInt(c.parent)||this.loaded.push(c.id)}this.loaded.length&&this.append(a)},append:function(a){var b="",c;for(c in a)parseInt(a[c].parent)||(b+=
this.get_fileitem(c));this.newfiles.append(b)},openimage:function(a){a=this.items[a];var b=parseInt(a.midle)?this.items[a.midle]:!1,b=b&&768>=d(f).width()?b:a;e.openimage({url:ltoptions.files+"/files/"+b.filename,width:parseInt(b.width),height:parseInt(b.height),title:a.title,description:a.description})},get_fileitem:function(a){a=this.items[a];a.link=ltoptions.files+"/files/"+a.filename;var b=a.media in this.tml?a.media:"file";"previewlink"in a||(a.previewlink="",parseInt(a.preview)&&a.preview in
this.items&&(a.previewlink=ltoptions.files+"/files/"+this.items[a.preview].filename));return d.parsetml(this.tml.item,{id:a.id,toolbar:this.tml.toolbar,content:d.parsetml(this.tml[b],a)})},init_uploader:function(){this.uploader=new e.Uploader;this.uploader.onupload.add(d.proxy(this.uploaded,this))},uploaded:function(a){try{var b=a.id;this.items[b]=a.item;parseInt(a.item.preview)&&(this.items[a.preview.id]=a.preview);parseInt(a.item.midle)&&(this.items[a.midle.id]=a.midle);this.add(b)}catch(c){erralert(c)}},
add:function(a){0>d.inArray(a,this.loaded)&&(this.loaded.push(a),this.newfiles.append(this.get_fileitem(a)))},remove:function(a){var b=d.inArray(a,this.loaded);if(0>b&&(a=parseInt(a),b=d.inArray(a,this.loaded),0>b))return;this.loaded.splice(b,1)},editprops:function(a,b){if(this.dialog)return!1;var c=this;this.dialog=new e.Filemanprops(this.items[a],function(){c.dialog=!1},function(d){c.items[d.item.id]=d.item;b.replaceWith(c.get_fileitem(a))})},browsefiles:function(){this.dialog=!0;this.browser?this.browser.open():
this.browser=new e.Filemanbrowser(this)}})})(jQuery,litepubl,window);
