/*
  2010 - 2016 Vladimir Yushko http://litepublisher.com/ http://litepublisher.ru/
 @license   https://github.com/litepubl/cms/blob/master/LICENSE.txt MIT
 @link https://github.com/litepubl\cms
 @version 6.15
*/
(function(d,g,h){g.Filemanbrowser=Class.extend({perpage:10,pages:!1,fileman:!1,css_small_height:"#posteditor-files-tabs.file-items {height:132px}",init:function(a){this.fileman=a;this.pages={};this.open()},add:function(a){this.fileman.add(a)},open:function(){var a=d(h).width(),b=d(h).height(),c=this;d.litedialog({title:lang.posteditor.selectfiles,html:this.get_html(),width:Math.min(720,a-120),height:Math.min(495,b-60),css:495>b-60?this.css_small_height:"",open:function(a){a.on("click.addfile",".file-item",
function(){var a=d(this);a.hasClass("file-added")||(a.addClass("file-added"),c.add(a.attr("data-idfile")));return!1});c.loadpage(a.find(".file-items:first"),"1");a=d("#posteditor-files-tabs",a);g.tabs(a,{before:function(a){a=a.children();"empty"==a.attr("data-status")&&c.loadpage(a,a.attr("data-page"))}})},close:function(){c.fileman.dialog=!1},buttons:[{title:lang.dialog.close,click:d.closedialog}]})},get_html:function(){for(var a=g.tml.fileman.tab,b=g.tabs.gettml(),c=Math.ceil(this.fileman.count/
this.perpage),k="",f="",e=1;e<=c;e++)k+=d.parsetml(b.head,{id:++g.guid,title:e}),f+=d.parsetml(b.tab,{id:g.guid,content:d.parsetml(a,{page:e})});return d.parsetml(b.tabs,{head:k,tab:f})},loadpage:function(a,b){if(b in this.pages)a.attr("data-status","loaded"),a.append(this.getpage(b));else{a.attr("data-status","loading");var c=this;d.jsonrpc({type:"get",method:"files_getpage",params:{page:b-1,perpage:this.perpage},callback:function(d){c.addpage(b,d.files);a.attr("data-status","loaded");a.append(c.getpage(b))},
error:function(b,c){a.attr("data-status","error");a.append("<p>"+b+"</p>")}})}},addpage:function(a,b){var c=this.pages[a]=[],d=this.fileman.items,f;for(f in b){var e=b[f];d[e.id]=e;parseInt(e.parent)||c.push(e.id)}},getpage:function(a){var b="";a=this.pages[a];var c=this.fileman,g=c.tml.toolbar;c.tml.toolbar="";for(var f=0,e=a.length;f<e;f++){var h=a[f];0>d.inArray(h,c.loaded)&&(b+=c.get_fileitem(h))}c.tml.toolbar=g;return b}})})(jQuery,litepubl,window);
