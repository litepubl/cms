(function(f,g,h){g.Filemanbrowser=Class.extend({perpage:10,pages:!1,fileman:!1,init:function(a){this.pages={};this.fileman=a;this.open()},add:function(a){this.fileman.add(a)},open:function(){var a=h.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,b=this;f.litedialog({title:lang.posteditor.selectfile,html:this.get_html(),width:Math.floor(a/4*3),open:function(a){a.on("click.addfile",".file-item:not(.file-added)",function(){b.add(f(this).addClass("file-added").attr("data-idfile"));
return!1});f("#posteditor-files-tabs",a).tabs({hide:!0,show:!0,beforeLoad:g.uibefore,beforeActivate:function(a,d){var c=f(d.newPanel.firstChild);"empty"==c.attr("data-status")&&b.loadpage(c,c.attr("data-page"))}})},buttons:[{title:lang.dialog.close,click:f.closedialog}]})},get_html:function(){for(var a=g.tml.fileman,b=Math.ceil(this.fileman.count/this.perpage),c="",e="",d=1;d<=b;d++)c+=a.tabhead.replace(/%%index%%/gim,d),e+=a.tab.replace(/%%index%%/gim,d);return f.parsetml(a.tabs,{head:c,body:e})},
loadpage:function(a,b){if(b in this.pages)a.attr("data-status","loaded"),a.append(this.getpage(b));else{var c=this;a.attr("data-status","loading");f.jsonrpc({type:"get",method:"files_getpage",params:{page:b-1},callback:function(e){c.addpage(b,e.files);a.attr("data-status","loaded");a.append(c.getpage(b))},error:function(b,c){a.attr("data-status","error");a.append("<p>"+b+"</p>")}})}},addpage:function(a,b){var c=this.pages[a]=[],e=this.fileman.items,d;for(d in b)e[d]=b[d],parseInt(b[d].parent)||c.push(d)},
getpage:function(a){var b="";a=this.pages[a];for(var c=this.fileman,e=0,d=a.length;e<d;e++){var g=a[e];0>f.inArray(g,c.loaded)&&(b+=c.get_fileitem(g))}return b}})})(jQuery,litepubl,window);
