(function(c,f,h){f.init_fileman=function(a){return new f.Fileman(a)};f.Fileman=Class.extend({items:!1,curr:!1,indialog:!1,holder:!1,init:function(a){try{this.items={};this.curr=[];a=c.extend({holder:"#posteditor-filelist",pages:0,items:!1},a);this.init_templates();this.holder=c(a.holder);var b=this;c("#posteditor-files-tabs",this.holder).tabs({hide:!0,show:!0,beforeLoad:f.uibefore,beforeActivate:function(a,d){"empty"==c(d.newPanel).data("files")&&b.loadpage(d.newPanel,c(d.newPanel).data("page"))}});
this.holder.closest("form").submit(function(){c("input[name='files']",b.holder).val(b.curr.join(","))});this.init_upload();a.items?this.set_uploaded(a.pages,a.items):this.load_current_files()}catch(d){erralert(d)}},init_templates:function(){this.tml=f.tml.fileman;c.replacetml(f.tml.fileman,{lang:lang.posteditor,iconurl:ltoptions.files+"/js/litepublisher/icons/"})},init_upload:function(){this.uploader=new f.Uploader;this.uploader.onupload.add(c.proxy(this.uploaded,this))},load_current_files:function(){var a=
this;c.jsonrpc({type:"get",method:"files_getpost",params:{idpost:ltoptions.idpost},callback:function(b){try{a.set_uploaded(b.count,b.files)}catch(c){erralert(c)}},error:function(a,d){c.messagebox(lang.dialog.error,a)}})},set_uploaded:function(a,b){this.set_tabs_count(a);for(var c in b){var e=b[c];this.items[e.id]=e;0==parseInt(e.parent)&&this.curr.push(e.id)}this.setpage("#current-files",b);this.setpage("#new-files",{})},set_tabs_count:function(a){if(!(1>a)){for(var b=c("#posteditor-files-tabs",this.holder),
d=c(".ui-tabs-nav",b),e=1;e<=a;e++)c(this.tml.tab.replace("%%index%%",e)).appendTo(b).data("page",e).data("files","empty"),c(this.tml.tabli.replace(/%%index%%/gim,e)).appendTo(d);b.tabs("refresh")}},setpage:function(a,b){var d=c(".file-items",a),e;for(e in b)0==parseInt(b[e].parent)&&d.append(this.get_fileitem(e));this.setborders(d);var g=this;d.on("click.toolbar",".file-toolbar a",function(){var a=c(this).closest(".file-item"),b=a.data("idfile");switch(c(this).attr("class")){case "add-toolbutton":g.add(b);
break;case "delete-toolbutton":g.del(b,a);break;case "property-toolbutton":g.editprops(b,a)}return!1});d.on("click.image","a.file-image",function(){g.openimage(c(this));return!1})},openimage:function(a){c.prettyPhoto.open(a.attr("href"),a.attr("title"),c("img",a).attr("alt"))},get_fileitem:function(a){var b=this.items[a];b.link=ltoptions.files+"/files/"+b.filename;b.previewlink="";var d=b.media in this.tml?b.media:"file";0!=parseInt(b.preview)&&b.preview in this.items&&(b.previewlink=ltoptions.files+
"/files/"+this.items[b.preview].filename);b=c.simpletml(this.tml.item,{id:b.id,content:c.simpletml(this.tml[d],b)});return c(b).data("idfile",a)},loadpage:function(a,b){var d=this;c(a).data("files","loading");c.jsonrpc({type:"get",method:"files_getpage",params:{page:b-1},callback:function(b){d.joinitems(b.files);d.setpage(a,b.files)},error:function(a,b){c.messagebox(lang.dialog.error,a)}})},joinitems:function(a){for(var b in a)this.items[b]=a[b]},uploaded:function(a){try{var b=a.id;this.curr.push(b);
this.items[b]=a.item;0!=parseInt(a.item.preview)&&(this.items[a.preview.id]=a.preview);c("#current-files .file-items").append(this.get_fileitem(b));c("#new-files .file-items").append(this.get_fileitem(b))}catch(d){erralert(d)}},setborders:function(a){var b=c(".file-item",a);if(0!=b.length){b.removeClass("border-left");var d=c(".file-item:first",a).position();b.each(function(){var a=c(this);a.position().left==d.left&&a.addClass("border-left")})}},add:function(a){0<=c.inArray(a,this.curr)||(this.curr.push(a),
this.setborders(c("#current-files .file-items").append(this.get_fileitem(a))))},del:function(a,b){var d=c.inArray(a,this.curr);if(0>d&&(a=parseInt(a),d=c.inArray(a,this.curr),0>d))return;this.curr.splice(d,1);d=b.parent();b.remove();this.setborders(d)},editprops:function(a,b){if(this.indialog)return!1;this.indialog=!0;var d=this.items[a],e=this;c.litedialog({title:lang.posteditor.property,html:this.tml.fileprops,open:function(a){c("input[name='fileprop-title']",a).val(d.title);c("input[name='fileprop-description']",
a).val(d.description);c("input[name='fileprop-keywords']",a).val(d.keywords)},buttons:[{title:"Ok",click:function(){var d=c(".pp_inline"),d={title:c.trim(c("input[name='fileprop-title']",d).val()),description:c.trim(c("input[name='fileprop-description']",d).val()),keywords:c.trim(c("input[name='fileprop-keywords']",d).val())};c.closedialog();e.setprops(a,d,b)}},{title:lang.dialog.cancel,click:function(){c.closedialog();e.indialog=!1}}]})},setprops:function(a,b,d){c.extend(this.items[a],b);b.idfile=
a;var e=this;return c.jsonrpc({method:"files_setprops",params:b,callback:function(b){e.items[b.item.id]=b.item;d&&d.replaceWith(e.get_fileitem(a));e.indialog=!1},error:function(a,b){e.indialog=!1;c.messagebox(lang.dialog.error,a)}})}})})(jQuery,litepubl,window);
